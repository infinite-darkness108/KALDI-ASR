# steps/nnet/train.sh --network-type blstm --learn-rate 0.00004 --cmvn-opts "--norm-means=true --norm-vars=true" --delta-opts --delta-order=2 --feat-type plain --splice 0 --scheduler-opts "--momentum 0.9 --halving-factor 0.5" --train-tool nnet-train-multistream-perutt --train-tool-opts "--num-streams=10 --max-frames=15000" --proto-opts "--cell-dim 320 --proj-dim 200 --num-layers 1" data-fbank/train_tr90 data-fbank/train_cv10 data/lang_bigram exp_FG/tri_8_2000_ali exp_FG/tri_8_2000_ali exp_FG/blstm4i 
# Started at Thu Aug  3 11:41:55 IST 2023
#
steps/nnet/train.sh --network-type blstm --learn-rate 0.00004 --cmvn-opts --norm-means=true --norm-vars=true --delta-opts --delta-order=2 --feat-type plain --splice 0 --scheduler-opts --momentum 0.9 --halving-factor 0.5 --train-tool nnet-train-multistream-perutt --train-tool-opts --num-streams=10 --max-frames=15000 --proto-opts --cell-dim 320 --proj-dim 200 --num-layers 1 data-fbank/train_tr90 data-fbank/train_cv10 data/lang_bigram exp_FG/tri_8_2000_ali exp_FG/tri_8_2000_ali exp_FG/blstm4i

# INFO
steps/nnet/train.sh : Training Neural Network
	 dir       : exp_FG/blstm4i 
	 Train-set : data-fbank/train_tr90 2624, exp_FG/tri_8_2000_ali 
	 CV-set    : data-fbank/train_cv10 296 exp_FG/tri_8_2000_ali 

LOG ([5.5.1074~1-71f3]:main():cuda-gpu-available.cc:61) 

### IS CUDA GPU AVAILABLE? 'speech-HP-Z2-Tower-G9' ###
WARNING ([5.5.1074~1-71f3]:SelectGpuId():cu-device.cc:243) Not in compute-exclusive mode.  Suggestion: use 'nvidia-smi -c 3' to set compute exclusive mode
LOG ([5.5.1074~1-71f3]:SelectGpuIdAuto():cu-device.cc:438) Selecting from 1 GPUs
LOG ([5.5.1074~1-71f3]:SelectGpuIdAuto():cu-device.cc:453) cudaSetDevice(0): NVIDIA RTX A2000 12GB	free:11506M, used:524M, total:12031M, free/total:0.956436
LOG ([5.5.1074~1-71f3]:SelectGpuIdAuto():cu-device.cc:501) Device: 0, mem_ratio: 0.956436
LOG ([5.5.1074~1-71f3]:SelectGpuId():cu-device.cc:382) Trying to select device: 0
LOG ([5.5.1074~1-71f3]:SelectGpuIdAuto():cu-device.cc:511) Success selecting device 0 free mem ratio: 0.956436
LOG ([5.5.1074~1-71f3]:FinalizeActiveGpu():cu-device.cc:338) The active GPU is [0]: NVIDIA RTX A2000 12GB	free:10992M, used:1038M, total:12031M, free/total:0.913713 version 8.6
### HURRAY, WE GOT A CUDA GPU FOR COMPUTATION!!! ##

### Testing CUDA setup with a small computation (setup = cuda-toolkit + gpu-driver + kaldi):
### Test OK!

# PREPARING ALIGNMENTS
Using PDF targets from dirs 'exp_FG/tri_8_2000_ali' 'exp_FG/tri_8_2000_ali'
hmm-info exp_FG/tri_8_2000_ali/final.mdl 
copy-transition-model --binary=false exp_FG/tri_8_2000_ali/final.mdl exp_FG/blstm4i/final.mdl 
LOG (copy-transition-model[5.5.1074~1-71f3]:main():copy-transition-model.cc:62) Copied transition model.

# PREPARING FEATURES
# re-saving features to local disk,
copy-feats --compress=true scp:data-fbank/train_tr90/feats.scp ark,scp:/tmp/kaldi.TBI7/train.ark,exp_FG/blstm4i/train_sorted.scp 
LOG (copy-feats[5.5.1074~1-71f3]:main():copy-feats.cc:143) Copied 2624 feature matrices.
copy-feats --compress=true scp:data-fbank/train_cv10/feats.scp ark,scp:/tmp/kaldi.TBI7/cv.ark,exp_FG/blstm4i/cv.scp 
LOG (copy-feats[5.5.1074~1-71f3]:main():copy-feats.cc:143) Copied 296 feature matrices.
# + 'apply-cmvn' with '--norm-means=true --norm-vars=true' using statistics : data-fbank/train_tr90/cmvn.scp, data-fbank/train_cv10/cmvn.scp
# + 'add-deltas' with '--delta-order=2'
feat-to-dim 'ark:copy-feats scp:exp_FG/blstm4i/train.scp.10k ark:- | apply-cmvn --norm-means=true --norm-vars=true --utt2spk=ark:data-fbank/train_tr90/utt2spk scp:data-fbank/train_tr90/cmvn.scp ark:- ark:- | add-deltas --delta-order=2 ark:- ark:- |' - 
copy-feats scp:exp_FG/blstm4i/train.scp.10k ark:- 
apply-cmvn --norm-means=true --norm-vars=true --utt2spk=ark:data-fbank/train_tr90/utt2spk scp:data-fbank/train_tr90/cmvn.scp ark:- ark:- 
add-deltas --delta-order=2 ark:- ark:- 
WARNING (feat-to-dim[5.5.1074~1-71f3]:Close():kaldi-io.cc:515) Pipe copy-feats scp:exp_FG/blstm4i/train.scp.10k ark:- | apply-cmvn --norm-means=true --norm-vars=true --utt2spk=ark:data-fbank/train_tr90/utt2spk scp:data-fbank/train_tr90/cmvn.scp ark:- ark:- | add-deltas --delta-order=2 ark:- ark:- | had nonzero return status 36096
# feature dim : 78 (input of 'feature_transform')
# + default 'feature_transform_proto' with splice +/-0 frames,
nnet-initialize --binary=false exp_FG/blstm4i/splice0.proto exp_FG/blstm4i/tr_splice0.nnet 
VLOG[1] (nnet-initialize[5.5.1074~1-71f3]:Init():nnet-nnet.cc:314) <Splice> <InputDim> 78 <OutputDim> 78 <BuildVector> -0:0 </BuildVector>
LOG (nnet-initialize[5.5.1074~1-71f3]:main():nnet-initialize.cc:63) Written initialized model to exp_FG/blstm4i/tr_splice0.nnet
# feature type : plain
# compute normalization stats from 10k sentences
compute-cmvn-stats ark:- exp_FG/blstm4i/cmvn-g.stats 
nnet-forward --print-args=true --use-gpu=yes exp_FG/blstm4i/tr_splice0.nnet 'ark:copy-feats scp:exp_FG/blstm4i/train.scp.10k ark:- | apply-cmvn --norm-means=true --norm-vars=true --utt2spk=ark:data-fbank/train_tr90/utt2spk scp:data-fbank/train_tr90/cmvn.scp ark:- ark:- | add-deltas --delta-order=2 ark:- ark:- |' ark:- 
WARNING (nnet-forward[5.5.1074~1-71f3]:SelectGpuId():cu-device.cc:243) Not in compute-exclusive mode.  Suggestion: use 'nvidia-smi -c 3' to set compute exclusive mode
LOG (nnet-forward[5.5.1074~1-71f3]:SelectGpuIdAuto():cu-device.cc:438) Selecting from 1 GPUs
LOG (nnet-forward[5.5.1074~1-71f3]:SelectGpuIdAuto():cu-device.cc:453) cudaSetDevice(0): NVIDIA RTX A2000 12GB	free:11506M, used:524M, total:12031M, free/total:0.956436
LOG (nnet-forward[5.5.1074~1-71f3]:SelectGpuIdAuto():cu-device.cc:501) Device: 0, mem_ratio: 0.956436
LOG (nnet-forward[5.5.1074~1-71f3]:SelectGpuId():cu-device.cc:382) Trying to select device: 0
LOG (nnet-forward[5.5.1074~1-71f3]:SelectGpuIdAuto():cu-device.cc:511) Success selecting device 0 free mem ratio: 0.956436
LOG (nnet-forward[5.5.1074~1-71f3]:FinalizeActiveGpu():cu-device.cc:338) The active GPU is [0]: NVIDIA RTX A2000 12GB	free:10992M, used:1038M, total:12031M, free/total:0.913713 version 8.6
copy-feats scp:exp_FG/blstm4i/train.scp.10k ark:- 
apply-cmvn --norm-means=true --norm-vars=true --utt2spk=ark:data-fbank/train_tr90/utt2spk scp:data-fbank/train_tr90/cmvn.scp ark:- ark:- 
add-deltas --delta-order=2 ark:- ark:- 
LOG (copy-feats[5.5.1074~1-71f3]:main():copy-feats.cc:143) Copied 2624 feature matrices.
LOG (apply-cmvn[5.5.1074~1-71f3]:main():apply-cmvn.cc:159) Applied cepstral mean and variance normalization to 2624 utterances, errors on 0
LOG (nnet-forward[5.5.1074~1-71f3]:main():nnet-forward.cc:192) Done 2624 files in 0.00735725min, (fps 1.71103e+06)
LOG (compute-cmvn-stats[5.5.1074~1-71f3]:main():compute-cmvn-stats.cc:168) Wrote global CMVN stats to exp_FG/blstm4i/cmvn-g.stats
LOG (compute-cmvn-stats[5.5.1074~1-71f3]:main():compute-cmvn-stats.cc:171) Done accumulating CMVN stats for 2624 utterances; 0 had errors.
# + normalization of NN-input at 'exp_FG/blstm4i/tr_splice0_cmvn-g.nnet'
nnet-concat --binary=false exp_FG/blstm4i/tr_splice0.nnet 'cmvn-to-nnet --std-dev=1.0 exp_FG/blstm4i/cmvn-g.stats -|' exp_FG/blstm4i/tr_splice0_cmvn-g.nnet 
LOG (nnet-concat[5.5.1074~1-71f3]:main():nnet-concat.cc:53) Reading exp_FG/blstm4i/tr_splice0.nnet
LOG (nnet-concat[5.5.1074~1-71f3]:main():nnet-concat.cc:65) Concatenating cmvn-to-nnet --std-dev=1.0 exp_FG/blstm4i/cmvn-g.stats -|
cmvn-to-nnet --std-dev=1.0 exp_FG/blstm4i/cmvn-g.stats - 
LOG (cmvn-to-nnet[5.5.1074~1-71f3]:main():cmvn-to-nnet.cc:114) Written cmvn in 'nnet1' model to: -
LOG (nnet-concat[5.5.1074~1-71f3]:main():nnet-concat.cc:82) Written model to exp_FG/blstm4i/tr_splice0_cmvn-g.nnet

### Showing the final 'feature_transform':
nnet-info exp_FG/blstm4i/tr_splice0_cmvn-g.nnet 
num-components 3
input-dim 78
output-dim 78
number-of-parameters 0.000156 millions
component 1 : <Splice>, input-dim 78, output-dim 78, 
  frame_offsets [ 0 ]
component 2 : <AddShift>, input-dim 78, output-dim 78, 
  shift_data ( min -0.00504125, max 1.60784e-05, mean -7.70579e-05, stddev 0.000573274, skewness -8.35074, kurtosis 69.1236 ) , lr-coef 0
component 3 : <Rescale>, input-dim 78, output-dim 78, 
  scale_data ( min 1, max 35.7274, mean 9.76604, stddev 8.7241, skewness 0.693612, kurtosis -0.643233 ) , lr-coef 0
LOG (nnet-info[5.5.1074~1-71f3]:main():nnet-info.cc:57) Printed info about exp_FG/blstm4i/tr_splice0_cmvn-g.nnet
###

# NN-INITIALIZATION
# getting input/output dims :
feat-to-dim 'ark:copy-feats scp:exp_FG/blstm4i/train.scp.10k ark:- | apply-cmvn --norm-means=true --norm-vars=true --utt2spk=ark:data-fbank/train_tr90/utt2spk scp:data-fbank/train_tr90/cmvn.scp ark:- ark:- | add-deltas --delta-order=2 ark:- ark:- | nnet-forward "exp_FG/blstm4i/final.feature_transform" ark:- ark:- |' - 
copy-feats scp:exp_FG/blstm4i/train.scp.10k ark:- 
apply-cmvn --norm-means=true --norm-vars=true --utt2spk=ark:data-fbank/train_tr90/utt2spk scp:data-fbank/train_tr90/cmvn.scp ark:- ark:- 
add-deltas --delta-order=2 ark:- ark:- 
nnet-forward exp_FG/blstm4i/final.feature_transform ark:- ark:- 
LOG (nnet-forward[5.5.1074~1-71f3]:SelectGpuId():cu-device.cc:168) Manually selected to compute on CPU.
WARNING (feat-to-dim[5.5.1074~1-71f3]:Close():kaldi-io.cc:515) Pipe copy-feats scp:exp_FG/blstm4i/train.scp.10k ark:- | apply-cmvn --norm-means=true --norm-vars=true --utt2spk=ark:data-fbank/train_tr90/utt2spk scp:data-fbank/train_tr90/cmvn.scp ark:- ark:- | add-deltas --delta-order=2 ark:- ark:- | nnet-forward "exp_FG/blstm4i/final.feature_transform" ark:- ark:- | had nonzero return status 36096
# genrating network prototype exp_FG/blstm4i/nnet.proto
# initializing the NN 'exp_FG/blstm4i/nnet.proto' -> 'exp_FG/blstm4i/nnet.init'
nnet-initialize --seed=777 exp_FG/blstm4i/nnet.proto exp_FG/blstm4i/nnet.init 
VLOG[1] (nnet-initialize[5.5.1074~1-71f3]:Init():nnet-nnet.cc:314) <BlstmProjected> <InputDim> 78 <OutputDim> 640 <CellDim> 320
VLOG[1] (nnet-initialize[5.5.1074~1-71f3]:Init():nnet-nnet.cc:314) <Tanh> <InputDim> 640 <OutputDim> 640
VLOG[1] (nnet-initialize[5.5.1074~1-71f3]:Init():nnet-nnet.cc:314) <AffineTransform> <InputDim> 640 <OutputDim> 1280 <BiasMean> 0.0 <BiasRange> 0.0
VLOG[1] (nnet-initialize[5.5.1074~1-71f3]:Init():nnet-nnet.cc:314) <Softmax> <InputDim> 1280 <OutputDim> 1280
LOG (nnet-initialize[5.5.1074~1-71f3]:main():nnet-initialize.cc:63) Written initialized model to exp_FG/blstm4i/nnet.init

# RUNNING THE NN-TRAINING SCHEDULER
steps/nnet/train_scheduler.sh --momentum 0.9 --halving-factor 0.5 --train-tool nnet-train-multistream-perutt --train-tool-opts --num-streams=10 --max-frames=15000 --feature-transform exp_FG/blstm4i/final.feature_transform --learn-rate 0.00004 exp_FG/blstm4i/nnet.init ark:copy-feats scp:exp_FG/blstm4i/train.scp ark:- | apply-cmvn --norm-means=true --norm-vars=true --utt2spk=ark:data-fbank/train_tr90/utt2spk scp:data-fbank/train_tr90/cmvn.scp ark:- ark:- | add-deltas --delta-order=2 ark:- ark:- | ark:copy-feats scp:exp_FG/blstm4i/cv.scp ark:- | apply-cmvn --norm-means=true --norm-vars=true --utt2spk=ark:data-fbank/train_cv10/utt2spk scp:data-fbank/train_cv10/cmvn.scp ark:- ark:- | add-deltas --delta-order=2 ark:- ark:- | ark:ali-to-pdf exp_FG/tri_8_2000_ali/final.mdl "ark:gunzip -c exp_FG/tri_8_2000_ali/ali.*.gz |" ark:- | ali-to-post ark:- ark:- | ark:ali-to-pdf exp_FG/tri_8_2000_ali/final.mdl "ark:gunzip -c exp_FG/tri_8_2000_ali/ali.*.gz |" ark:- | ali-to-post ark:- ark:- | exp_FG/blstm4i
CROSSVAL PRERUN AVG.LOSS 7.3613 (Xent),
ITERATION 01: TRAIN AVG.LOSS 4.1309, (lrate4e-05), CROSSVAL AVG.LOSS 3.4422, nnet accepted (nnet_iter01_learnrate0.00004_tr4.1309_cv3.4422)
ITERATION 02: TRAIN AVG.LOSS 2.0871, (lrate4e-05), CROSSVAL AVG.LOSS 2.6616, nnet accepted (nnet_iter02_learnrate0.00004_tr2.0871_cv2.6616)
ITERATION 03: TRAIN AVG.LOSS 1.5242, (lrate4e-05), CROSSVAL AVG.LOSS 2.2914, nnet accepted (nnet_iter03_learnrate0.00004_tr1.5242_cv2.2914)
ITERATION 04: TRAIN AVG.LOSS 1.2117, (lrate4e-05), CROSSVAL AVG.LOSS 2.0752, nnet accepted (nnet_iter04_learnrate0.00004_tr1.2117_cv2.0752)
ITERATION 05: TRAIN AVG.LOSS 0.9972, (lrate4e-05), CROSSVAL AVG.LOSS 2.0506, nnet accepted (nnet_iter05_learnrate0.00004_tr0.9972_cv2.0506)
ITERATION 06: TRAIN AVG.LOSS 0.8452, (lrate4e-05), CROSSVAL AVG.LOSS 2.0237, nnet accepted (nnet_iter06_learnrate0.00004_tr0.8452_cv2.0237)
ITERATION 07: TRAIN AVG.LOSS 0.7455, (lrate4e-05), CROSSVAL AVG.LOSS 1.9889, nnet accepted (nnet_iter07_learnrate0.00004_tr0.7455_cv1.9889)
ITERATION 08: TRAIN AVG.LOSS 0.6686, (lrate4e-05), CROSSVAL AVG.LOSS 1.8011, nnet accepted (nnet_iter08_learnrate0.00004_tr0.6686_cv1.8011)
ITERATION 09: TRAIN AVG.LOSS 0.6078, (lrate4e-05), CROSSVAL AVG.LOSS 1.9331, nnet rejected (nnet_iter09_learnrate0.00004_tr0.6078_cv1.9331_rejected)
ITERATION 10: TRAIN AVG.LOSS 0.5131, (lrate2e-05), CROSSVAL AVG.LOSS 2.0002, nnet rejected (nnet_iter10_learnrate2e-05_tr0.5131_cv2.0002_rejected)
finished, too small rel. improvement 0
steps/nnet/train_scheduler.sh: Succeeded training the Neural Network : 'exp_FG/blstm4i/final.nnet'
steps/nnet/train.sh: Successfuly finished. 'exp_FG/blstm4i'
# Removing features tmpdir /tmp/kaldi.TBI7 @ speech-HP-Z2-Tower-G9
cv.ark
train.ark
# Accounting: time=242 threads=1
# Ended (code 0) at Thu Aug  3 11:45:57 IST 2023, elapsed time 242 seconds
